---
title: "Plots together"
output: html_document
---

Combine plots together:

```{r}
rm(list = ls())
load('results/df_cc.Rdata')
load('results/df_qtrait.Rdata')

library(ggplot2)
library(cowplot)
cbbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", 
                "#0072B2", "#D55E00", "#CC79A7", "#c5679b", "#be548f")
```

# Plot of simulation result, one time run

Require run `1_npdr_cc.Rmd`, `1_npdr_qtrait.Rmd`.

## Generate figure 1:

```{r}
# Continuous outcome:
## NPDR vs Relief-F score:
p_qtrait <- ggplot(test_df_qtrait, aes(x = rrelief, y = beta.Z.att)) + 
  geom_smooth(method = "lm", se = F, color = "grey") + 
  geom_point(aes(colour = functional), alpha = 0.7, size = 2) +
  theme_bw() + theme(legend.position = c(0.22, 0.87), legend.margin = margin(c(1,1,1,1))) +
  labs(colour = NULL, x = "Relief-F score", y = "NPDR coefficient",
       title = NULL) +
  scale_color_manual(values = cbbPalette[c(1,2)],
                     labels = c('Non-functional', 'Functional')) +
  annotate("text", x = 0.23, y = 80, label = deparse(bquote(R^2 == .(r2_qtrait))), parse = T) +
  annotate("text", 0.25, npdr.beta.cutoff.qtrait + 3, label = "NPDR cutoff", size = 4, color = cbbPalette[1]) +
  geom_hline(yintercept=npdr.beta.cutoff.qtrait, linetype="dashed", alpha = 0.5)
p_qtrait
## PR curve:
q_qtrait <- prr_dat_qtrait %>%
  ggplot(aes(Recall, Precision, color = type)) +
  geom_path(size = 1) + theme_bw() +
  scale_color_manual(values = cbbPalette[c(6,8)]) + 
  scale_x_continuous(limits = c(0, 1.05), breaks = seq(0, 1.1, 0.2), labels = scales::percent) + 
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.2), labels = scales::percent) + 
  annotate('text', x = 0.74, y = 0.9 , label = paste0('NPDR \n AUC = ', auprc_npdr_qtrait), color = cbbPalette[6]) +
  annotate('text', x = 0.23, y = 0.58, label = paste0('Relief-F \n AUC = ', auprc_relief_qtrait), color = cbbPalette[8]) +
  guides(color = FALSE)

# Binary outcome:
## NPDR vs Relief-F score:
p_cc <- ggplot(test_df_cc, aes(x = rrelief, y = beta.Z.att)) + 
  geom_smooth(method = "lm", se = F, color = "grey") + 
  geom_point(aes(colour = functional), alpha = 0.7, size = 2) +
  theme_bw() + theme(legend.position = c(0.22, 0.87), legend.margin = margin(c(1,1,1,1))) +
  labs(colour = NULL, x = "Relief-F score", y = "NPDR coefficient",
       title = NULL) +
  scale_color_manual(values = cbbPalette[c(1,2)],
                     labels = c('Non-functional', 'Functional')) +
  annotate("text", x = 0.055, y = 24, label = deparse(bquote(R^2 == .(r2_cc))), parse = T) +
  annotate("text", 0.062, npdr.beta.cutoff.cc + 1, label = "NPDR cutoff", size = 4, color = cbbPalette[1]) +
  geom_hline(yintercept=npdr.beta.cutoff.cc, linetype="dashed", alpha = 0.5)
p_cc
## PR curve:
q_cc <- prr_dat_cc %>%
  ggplot(aes(Recall, Precision, color = type)) +
  geom_path(size = 1) + theme_bw() +
  scale_color_manual(values = cbbPalette[c(6,8)]) + 
  scale_x_continuous(limits = c(0, 1.05), breaks = seq(0, 1.1, 0.2), labels = scales::percent) + 
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.2), labels = scales::percent) + 
  annotate('text', x = 0.71, y = 0.91 , label = paste0('NPDR \n AUC = ', auprc_npdr_cc), color = cbbPalette[6]) +
  annotate('text', x = 0.71, y = 0.4, label = paste0('Relief-F \n AUC = ', auprc_relief_cc), color = cbbPalette[8]) +
  guides(color = FALSE) #+ 

p_cc
```


```{r}
qtrait <- plot_grid(p_qtrait, q_qtrait, labels=c('A', 'B'))
title_q <- ggdraw() + draw_label('Continuous outcome data with main effect')
qp <- plot_grid(title_q, qtrait, ncol=1, rel_heights=c(0.1, 1)) 

cc <- plot_grid(p_cc, q_cc, labels=c('C', 'D'))
title_c <- ggdraw() + draw_label('Binary outcome data with interaction effect') 
ccp <- plot_grid(title_c, cc, ncol=1, rel_heights=c(0.1, 1)) 
 
fig1 <- plot_grid(qp, ccp, nrow = 2)
ggsave(fig1, filename = 'figs/fig1.svg', height = 7, width = 7)
ggsave(fig1, filename = 'figs/fig1.pdf', height = 7, width = 7)
```


## auROC for Supplement:

```{r}
ss_df <- rbind(ss_df_cc, ss_df_qtrait) %>%
  mutate(sim = rep(c('Binary outcome', 'Continuous outcome'), each = nrow(ss_df_cc)))

npdr_text <- data.frame(
  label = c(paste0('NPDR \n AUC = ', auroc_npdr_cc), 
            paste0('NPDR \n AUC = ', auroc_npdr_qtrait)),
  sim = c('Binary outcome', 'Continuous outcome'),
  x = c(0.77, 0.865), y = c(0.9, 0.95), type = c('NPDR', 'NPDR')
)

relief_text <- data.frame(
  label = c(paste0('Relief-F \n AUC = ', auroc_relief_cc), 
            paste0('Relief-F \n AUC = ', auroc_relief_qtrait)),
  sim = c('Binary outcome', 'Continuous outcome'),
  x = c(0.77, 0.62), y = c(0.5, 0.5), type = c('Relief', 'Relief')
)

roc <- ggplot(ss_df, aes(x = Sensitivity, y = Specificity, color = type)) +   
  geom_path(size = 1) + theme_bw() + facet_wrap(~ sim) +
  scale_color_manual(values = cbbPalette[c(6,8)]) +
  scale_x_reverse(breaks = seq(1, 0, -0.2), labels = scales::percent) + 
  scale_y_continuous(breaks = seq(0, 1, 0.2), labels = scales::percent) + 
  geom_text(npdr_text, mapping = aes(x = x, y = y, label = label)) +
  geom_text(relief_text, mapping = aes(x = x, y = y, label = label)) +
  guides(color = FALSE)

roc
ggsave(roc, filename = 'figs/npdr_relief_auroc.pdf', height = 4 , width = 6)
```


## Compare NPDR and STIR:
Require run `1_npdr_cc.Rmd`.
```{r}
p <- ggplot(npdr_stir, aes(x=stir.log10,y=npdr.log10)) + 
  geom_smooth(method = 'lm', se = F, color = 'grey') + 
  geom_point(aes(colour = functional), alpha = 0.7, size = 3) +
  theme_bw() + theme(legend.position = c(0.78, 0.23)) +
  labs(colour = NULL, 
       x = bquote('STIR ('~-log[10]~'p'~')'), 
       y = bquote('NPDR ('~-log[10]~'p'~')'),
       title = NULL) + 
  annotate("text", x = 130, y = 130, label = deparse(bquote(R^2 > 0.99)), parse = T) +
  scale_color_manual(values = cbbPalette[c(1,2)],
                     labels = c('Non-functional', 'Functional')) +
  # viridis::scale_color_viridis(discrete = TRUE, 
  #                              labels = c('Non-functional', 'Functional')) + 
  geom_vline(xintercept=pcutoff, linetype="dashed", alpha = 0.5) +
  geom_hline(yintercept=pcutoff, linetype="dashed", alpha = 0.5)
p
ggsave(p, filename = paste0('figs/npdr_stir_p_cc.pdf'), height = 4.5, width = 4.5 )
```

# Replications of auPRC for Supplement:
Require run `2_npdr_relief_100_cc.Rmd`, `2_npdr_relief_100_qtrait.Rmd`.

```{r}
load('results/npdr_100_cc.Rdata')
pr_cc_100 <- pr_df

load('results/npdr_100_qtrait.Rdata')
pr_qtrait_100 <- pr_df

# pr_df
pr_df <- rbind(pr_cc_100, pr_qtrait_100) %>%
  mutate(sim = rep(c('Binary outcome', 'Continuous outcome'), each = nrow(pr_qtrait_100)))

p_text <- data.frame(
  label = c('p < 0.0001', 'p < 0.0001'),
  sim = c('Binary outcome', 'Continuous outcome'),
  x = c(1.5, 1.5), y = c(0.56, 0.47), type = c('NPDR', 'Relief-F')
)

pr_100 <- ggplot(pr_df, aes(x = type, y = aupr, fill = type, color = type)) + 
  geom_boxplot(alpha = 0.3, color = 'grey30', outlier.size = -1, width = 0.5) +
  labs(x = NULL, y = 'Area under the PR curve') + facet_wrap(~ sim, scales = 'free') +
  geom_jitter(height = 0, width = 0.1) +
  scale_color_manual(values = cbbPalette[c(8,6)]) +
  scale_fill_manual(values = cbbPalette[c(8,6)]) +
  geom_text(p_text, mapping = aes(x = x, y = y, label = label), color = 'grey20') +
  # annotate("text", x = 1.5, y = 0.5, label = paste('p < 0.0001')) + 
  theme_bw() + guides(fill = F, color = F) 
pr_100

ggsave(pr_100, filename = paste0('figs/pr_compare_100.pdf'), height = 3, width = 5)
```

