---
title: "Plots together"
output: html_document
---

Combine plots together:

```{r}
rm(list = ls())
load('results/df_cc.Rdata')
load('results/df_qtrait.Rdata')
load('results/rf_cc.Rdata')
load('results/rf_qtrait.Rdata')

library(tidyverse)
library(cowplot)
cbbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", 
                "#0072B2", "#D55E00", "#CC79A7", "#c5679b", "#be548f")
```

# Plot of simulation result, one time run

Require run `1_npdr_cc.Rmd`, `1_npdr_qtrait.Rmd`.

## Get the statistics:

```{r}
alpha <- 0.05
n.variables <- 1000
pct.signals <- 0.1
true.pos <- test_df_qtrait %>%
  filter((pval.adj < alpha) & functional) %>%
  nrow()
n.pos <- test_df_qtrait %>%
  filter((pval.adj < alpha)) %>%
  nrow()
(npdr.recall.qtrait <- true.pos/(n.variables*pct.signals))
(npdr.precis.qtrait <- true.pos/n.pos)

alpha <- 0.05
true.pos <- test_df_cc %>%
  filter((pval.adj < alpha) & functional) %>%
  nrow()
n.pos <- test_df_cc %>%
  filter((pval.adj < alpha)) %>%
  nrow()
(npdr.recall.cc <- true.pos/(n.variables*pct.signals))
(npdr.precis.cc <- true.pos/n.pos)
```


## Generate figure 1:

Set theme:

```{r}
plot_r2 <- function(x){
  x + geom_smooth(method = "lm", se = F, color = 'grey') + 
  facet_wrap(~ method, scale = 'free_x', strip.position = 'bottom') +
  geom_point(aes(colour = functional), alpha = 0.7, size = 2) +
  scale_x_continuous(breaks = scales::pretty_breaks(4)) + 
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5, size = 12),
      strip.placement = 'outside',
      strip.switch.pad.wrap = unit(0, 'mm'),
      strip.text = element_text(size = 10.5),
      strip.background = element_rect(colour=NA, fill=NA),
      legend.position = c(0.66, 0.87),
      legend.key.width = unit(1, "line"),
      legend.key.height = unit(0.8, "line"),
      legend.text = element_text(size = 8),
      legend.title = element_text(size = 8),
      legend.margin = margin(c(1,1,1,1))) +
  scale_color_manual(values = cbbPalette[c(1,2)], labels = c('Non-functional', 'Functional')) +
  geom_text(cutoff_text, mapping = aes(x = x, y = y, label = label) , size = 3, color = cbbPalette[1]) + 
  geom_text(r2_text, mapping = aes(x = x, y = y, label = label), size = 3, parse = T)
}
```

Now plot:

```{r}
# Continuous outcome:
qtrait_methods <-  c('RRelief score', 'Random forest score')
cc_methods <-  c('Relief-F score', 'Random forest score')
qtrait_r <- merge(test_df_qtrait, rf_npdr_qtrait) %>%
  select(rrelief, beta.Z.att, functional, X.IncMSE) %>%
  rename(`RRelief score` = rrelief, `Random forest score` = X.IncMSE) %>%
  gather('method', 'imp_score', c(`RRelief score`, `Random forest score`))
qtrait_r$method <- factor(qtrait_r$method, levels = qtrait_methods)
cc_r <- merge(test_df_cc, rf_npdr_cc) %>%
  select(rrelief, beta.Z.att, functional, MeanDecreaseAccuracy) %>%
  rename(`Relief-F score` = rrelief, `Random forest score` = MeanDecreaseAccuracy) %>%
  gather('method', 'imp_score', c(`Relief-F score`, `Random forest score`))
cc_r$method <- factor(cc_r$method, levels = cc_methods)


cutoff_text <- data.frame(
  label = rep('NPDR cutoff', 2), method = qtrait_methods,
  x = c(0.24, 18), y = c(npdr.beta.cutoff.qtrait + 4, npdr.beta.cutoff.qtrait + 4))
r2_text <- data.frame(
  label = c(deparse(bquote(R^2 == .(r2_qtrait))), deparse(bquote(R^2 == .(r2_rf_qtrait)))),
  method = qtrait_methods, x = c(0.25, 19), y = c(80, 80))
qtrait_plot <- ggplot(qtrait_r, aes(x = imp_score, y = beta.Z.att)) + 
  labs(x = NULL, title = 'Continuous outcome data with main effect', 
       y = bquote('NPDR linear'~beta), color = NULL) +
  geom_hline(yintercept = npdr.beta.cutoff.qtrait, linetype='dashed', alpha = 0.5)
qtrait_plot <- plot_r2(qtrait_plot)

# Dichotomous outcome:
cutoff_text <- data.frame(
  label = rep('NPDR cutoff', 2), method = cc_methods,
  x = c( 0.06, 3.7), y = c(npdr.beta.cutoff.cc + 1.25, npdr.beta.cutoff.cc + 1.25))
r2_text <- data.frame(
  label = c(deparse(bquote(R^2 == .(r2_cc))), deparse(bquote(R^2 == .(r2_rf_cc)))),
  method = cc_methods, x = c(0.062, 4) , y = c(24, 24))
cc_plot <- ggplot(cc_r, aes(x = imp_score, y = beta.Z.att)) + 
  labs(x = NULL, title = 'Dichotomous outcome data with interaction effect', 
       y = bquote('NPDR logistic'~beta), color = NULL) +
  geom_hline(yintercept=npdr.beta.cutoff.qtrait, linetype='dashed', alpha = 0.5)
cc_plot <- plot_r2(cc_plot)

 
fig1 <- plot_grid(qtrait_plot, cc_plot, nrow = 2, labels = 'AUTO')
ggsave(fig1, filename = 'figs/fig1.pdf', height = 5.5, width = 4.8)
```


## Generate figure 2:

```{r}
pr_qtrait <- prr_rf_qtrait %>%
  filter(type != 'NPDR') %>%
  rbind(prr_dat_qtrait) #%>% 

pr_cc <- prr_rf_cc %>% 
  filter(type != 'NPDR') %>%
  rbind(prr_dat_cc) #%>% 

relief_text <- data.frame(
  label = c(paste0('RRelief \n ', auprc_relief_qtrait), 
            paste0('Relief-F \n', auprc_relief_cc)),
  sim = c('Continuous outcome', 'Dichotomous outcome'),
  x = c(0.485 , 0.28), y = c(0.7, 0.91), type = c('Relief-F', 'Relief-F')
)

npdr_text <- data.frame(
  label = c(paste0('NPDR \n ', auprc_npdr_qtrait), 
            paste0('NPDR \n   ', auprc_npdr_cc)),
  sim = c('Continuous outcome', 'Dichotomous outcome'),
  x = c(0.755, 0.815), y = c(0.45, 0.88), type = c('NPDR', 'NPDR')
)

rf_text <- data.frame(
  label = c(paste0('Random forest \n', auprc_rf_qtrait), 
            paste0('Random forest \n', auprc_rf_cc)),
  sim = c('Continuous outcome', 'Dichotomous outcome'),
  x = c( 0.3, 0.65), y = c(0.2, 0.2), type = c('Random forest', 'Random forest')
)

cutoff_point <- data.frame(
  sim = c('Continuous outcome', 'Dichotomous outcome'),
  x = c(npdr.recall.qtrait, npdr.recall.cc), y = c(npdr.precis.qtrait, npdr.precis.cc), 
  type = c('NPDR', 'NPDR')
)

pr <- rbind(pr_qtrait, pr_cc) %>% #data.frame() %>%
  mutate(sim = c(rep('Continuous outcome', nrow(pr_qtrait)), rep('Dichotomous outcome', nrow(pr_cc)))) %>%
  ggplot(aes(Recall, Precision, color = type)) +
  geom_path(size = 0.8) + theme_bw() +
  facet_wrap(~ sim) + 
  scale_color_manual(values = cbbPalette[c(8,3,6)]) +
  scale_x_continuous(limits = c(0, 1.05), breaks = seq(0, 1.1, 0.2), labels = scales::percent) +
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.2), labels = scales::percent) +
  geom_text(rf_text, mapping = aes(x = x, y = y, label = label), size = 3) +
  geom_text(npdr_text, mapping = aes(x = x, y = y, label = label), size = 3) +
  geom_text(relief_text, mapping = aes(x = x, y = y, label = label), size = 3) + 
  geom_point(cutoff_point, mapping = aes(x = x, y = y), shape = 8, size = 2, stroke = 1) +
  guides(color = FALSE)
pr

ggsave(pr, filename = 'figs/fig2_pr_plots.pdf', width = 6.2, height = 3)
```


## Compare NPDR and STIR:
Require run `1_npdr_cc.Rmd`.
```{r}
p <- ggplot(npdr_stir, aes(x=stir.log10,y=npdr.log10)) + 
  geom_smooth(method = 'lm', se = F, color = 'grey') + 
  geom_point(aes(colour = functional), alpha = 0.7, size = 3) +
  theme_bw() + theme(legend.position = c(0.78, 0.23)) +
  labs(colour = NULL, 
       x = bquote('STIR ('~-log[10]~'p'~')'), 
       y = bquote('NPDR ('~-log[10]~'p'~')'),
       title = NULL) + 
  annotate("text", x = 130, y = 130, label = deparse(bquote(R^2 > 0.99)), parse = T) +
  scale_color_manual(values = cbbPalette[c(1,2)],
                     labels = c('Non-functional', 'Functional')) +
  geom_vline(xintercept=pcutoff, linetype='dashed', alpha = 0.5) +
  geom_hline(yintercept=pcutoff, linetype='dashed', alpha = 0.5)
p
ggsave(p, filename = paste0('figs/npdr_stir_p_cc.pdf'), height = 4.5, width = 4.5 )
```

# Replications of auPRC for Supplement:
Require run `2_npdr_relief_100_cc.Rmd`, `2_npdr_relief_100_qtrait.Rmd`.

```{r}
load('results/npdr_100_cc.Rdata')
pr_cc_100 <- pr_df

load('results/npdr_100_qtrait.Rdata')
pr_qtrait_100 <- pr_df

# pr_df
pr_df <- rbind(pr_cc_100, pr_qtrait_100) %>%
  mutate(sim = c(rep('Dichotomous outcome', nrow(pr_cc_100)), 
         rep('Continuous outcome', nrow(pr_qtrait_100)))) %>%
  mutate(newtype = as.factor(case_when((type %in% c('Relief-F', 'RRelief')) ~ 'Relief',
                             TRUE ~ as.character(type))))
pr_df$newtype <- factor(pr_df$newtype, levels = c( 'Random forest', 'Relief', 'NPDR'))

pr_100 <- ggplot(pr_df, aes(x = newtype, y = aupr, fill = newtype, color = newtype)) + 
  geom_boxplot(alpha = 0.5, color = 'grey30', outlier.size = -1, width = 0.5) +
  labs(x = NULL, y = 'Area under the PR curve') + facet_wrap(~ sim) +
  geom_jitter(height = 0, width = 0.1) +
  scale_y_continuous(breaks = seq(0, 1, 0.2), 
                     labels = scales::percent_format(accuracy = 1),
                     limits = c(NA, 1.08)) + 
  scale_color_manual(values = cbbPalette[c(3, 6, 8)]) +
  scale_fill_manual(values = cbbPalette[c(3, 6, 8)]) +
  ggsignif::geom_signif(comparisons = list(c('Random forest', 'NPDR')), 
              map_signif_level=TRUE, y_position = 1.06, vjust = 0.5, tip_length = 0) +
  ggsignif::geom_signif(comparisons = list(c('Relief', 'NPDR')), 
              map_signif_level=TRUE, y_position = 1.02, vjust = 0.5, tip_length = 0) +
  theme_bw() + guides(fill = F, color = F) 
pr_100

ggsave(pr_100, filename = paste0('figs/pr_compare_100.pdf'), height = 3, width = 5)
```


## auROC for Supplement:

```{r}
ss_df <- rbind(ss_df_cc, ss_df_qtrait) %>%
  mutate(sim = c(rep('Dichotomous outcome', nrow(ss_df_cc)),
                 rep('Continuous outcome', nrow(ss_df_qtrait))))

npdr_text <- data.frame(
  label = c(paste0('NPDR ', round(auroc_npdr_cc, 3)), 
            paste0('NPDR\n', round(auroc_npdr_qtrait, 3))),
  sim = c('Dichotomous outcome', 'Continuous outcome'),
  x = c(0.85, 0.77), y = c(1.05, 1), type = c('NPDR', 'NPDR')
)

relief_text <- data.frame(
  label = c(paste0('Relief-F \n', round(auroc_relief_cc, 3)), 
            paste0('RRelief \n', round(auroc_relief_qtrait, 3))),
  sim = c('Dichotomous outcome', 'Continuous outcome'),
  x = c(0.8, 0.79), y = c(0.38, 0.1), type = c('Relief', 'Relief')
)

rf_text <- data.frame(
  label = c(paste0('Random forest \n', round(auroc_rf_cc, 3)), 
            paste0('Random forest \n', round(auroc_rf_qtrait, 3))),
  sim = c('Dichotomous outcome', 'Continuous outcome'),
  x = c(0.6, 0.33), y = c(0.63, 0.6), type = c('Random forest', 'Random forest')
)


roc <- ggplot(ss_df, aes(x = Sensitivity, y = Specificity, color = type)) +   
  geom_path(size = 0.8) + theme_bw() + facet_wrap(~ sim) +
  scale_color_manual(values = cbbPalette[c(8,3,6)]) +
  scale_x_reverse(breaks = seq(1, 0, -0.2), labels = scales::percent) + 
  scale_y_continuous(breaks = seq(0, 1, 0.2), labels = scales::percent, limits = c(NA, 1.08)) + 
  geom_text(npdr_text, mapping = aes(x = x, y = y, label = label), size = 3) +
  geom_text(relief_text, mapping = aes(x = x, y = y, label = label), size = 3) +
  geom_text(rf_text, mapping = aes(x = x, y = y, label = label), size = 3) +
  guides(color = FALSE)

roc

rocs <- plot_grid(roc, roc_100, nrow = 2, labels = 'AUTO')
rocs

ggsave(rocs, filename = paste0('figs/roc_compare_100.pdf'), height = 5, width = 5)
```




# Replications of auROC for Supplement:

Must run `2_npdr_relief_100_cc_auroc.Rmd` and `2_npdr_relief_100_qtrait_auroc.Rmd`:

```{r}
load('results/npdr_100_cc_auroc.Rdata')
roc_cc_100 <- roc_df

load('results/npdr_100_qtrait_auroc.Rdata')
roc_qtrait_100 <- roc_df

roc_df <- rbind(roc_cc_100, roc_qtrait_100) %>%
  mutate(sim = c(rep('Dichotomous outcome', nrow(roc_cc_100)), 
         rep('Continuous outcome', nrow(roc_qtrait_100)))) %>%
  mutate(newtype = as.factor(case_when((type %in% c('Relief-F', 'RRelief')) ~ 'Relief',
                             TRUE ~ as.character(type))))
roc_df$newtype <- factor(roc_df$newtype, levels = c('Random forest', 'Relief', 'NPDR'))

roc_100 <- ggplot(roc_df, aes(x = newtype, y = aupr, fill = newtype, color = newtype)) + 
  geom_boxplot(alpha = 0.5, color = 'grey30', outlier.size = -1, width = 0.5) +
  labs(x = NULL, y = 'Area under the ROC curve') + facet_wrap(~ sim) +
  geom_jitter(height = 0, width = 0.1) +
  scale_y_continuous(breaks = seq(0, 1, 0.1), 
                     labels = scales::percent_format(accuracy = 1),
                     limits = c(NA, 1.08)) + 
  scale_color_manual(values = cbbPalette[c(3, 6, 8)]) +
  scale_fill_manual(values = cbbPalette[c(3, 6, 8)]) +
  ggsignif::geom_signif(comparisons = list(c('Random forest', 'NPDR')), 
              map_signif_level=TRUE, y_position = 1.06, vjust = 0.5, tip_length = 0) +
  ggsignif::geom_signif(comparisons = list(c('Relief', 'NPDR')), 
              map_signif_level=TRUE, y_position = 1.02, vjust = 0.5, tip_length = 0) +
  theme_bw() + guides(fill = F, color = F)
roc_100
rocs <- plot_grid(roc, roc_100, nrow = 2, labels = 'AUTO')
rocs

ggsave(rocs, filename = paste0('figs/roc_compare_100.pdf'), height = 5, width = 5)
```

